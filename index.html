<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1" />
        <title>Spagbol Roster</title>
        <link href='http://fonts.googleapis.com/css?family=Carter+One' rel='stylesheet' type='text/css'>
        <link type="text/css" href="jqueryui/css/ui-lightness/jquery-ui-1.8.13.custom.css" rel="stylesheet" />
        <script type="text/javascript" src="jqueryui/js/jquery-1.5.1.min.js"></script>
        <script type="text/javascript" src="jqueryui/js/jquery-ui-1.8.13.custom.min.js"></script>
        <script type="text/javascript">
            $(function(){
                /* *********************** */
                // THINGS TO DO AT THE START:
                /* *********************** */
                var messageElement = $( "#message" );
                messageElement.hide();

                /* Initialize the Reason input field */
                $(function() {
                        var availableReasons = [
                            "I'm not feeling well",
                            "I've swapped nights with someone",
                            "Too many public holidays this week",
                            "No one home",
                            "I found Jesus"
                        ];
                        $( "#reason" ).autocomplete({
                            source: availableReasons
                        });
                    });
                /* *********************** */

                assignAllCooksToNoDay();

                loadCookingDaysFromServer();
                /* *********************** */


                $( "div[id^='draggable']" ).draggable({ helper: "clone" , cursor: "move" });

                $( "#weekday-monday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-tuesday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-wednesday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-thursday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-friday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-saturday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-sunday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });
                $( "#weekday-noday" ).droppable({ drop: handleDrop,
                                                   hoverClass: "ui-state-active" });

                function handleDrop( event, ui ) {
                    //Get Details of dragged and dropped
                    var cook = ui.draggable;
                    var day = $(this)

                    $(cook).detach().css({top: 0, left: 0}).appendTo(day);

                }

                function assignAllCooksToNoDay() {
                    cooks = $( "div[id^='draggable']" );

                    $.each(cooks, function(index) {
                        assignCookToDay( "noday", $(this) );
                    })
                }

                function loadCookingDaysFromServer() {
                    $.ajax({
                        type: 'GET',
                        url: "/loadSchedule",
                        contentType: "application/json",
                        success: function(json) {
                                var data = $.parseJSON(json);
                                if (data == null) {
                                    data = json;
                                }

                                $.each(data, function(key, val) {
                                       cook = key
                                       day = val
                                       assignCookToDay(day, $( "#draggable-" + cook ) );
                                   });

                                showMessage("info", onLoadMessage);
                             }
                     });
                }

                function assignCookToDay( day, cookElement ) {
                    var dayElement = $( "#weekday-" + day );

                    cookElement.detach().css({top: 0, left: 0}).appendTo(dayElement);
                }

                onLoadMessage = "<b>Schedule loaded</b>. Drag the names around and click <b>Save & Notify</b> to change it.";
                var saveButton = $( ".save button:first" ).button({
                                             icons: { primary: "ui-icon-gear" }
                                                 }).click(saveAndNotify);
                if (saveButton.hasClass( "out" )) { // User is logged out
                    saveButton.hide();
                    onLoadMessage = "Log in to make changes to the schedule.";
                }

                $("#agnes-turn-progress").progressbar({
                    value: {{ agnes_progress }}
                });

                function saveAndNotify() {
                    chrisElement = $( "#draggable-chris" );
                    chrisDay = chrisElement.parent()[0].id.split('-')[1]
                    nickElement = $( "#draggable-nick" );
                    nickDay = nickElement.parent()[0].id.split('-')[1]
                    steveElement = $( "#draggable-steve" );
                    steveDay = steveElement.parent()[0].id.split('-')[1]
                    zakElement = $( "#draggable-zak" );
                    zakDay = zakElement.parent()[0].id.split('-')[1]

                    reason = $( "#reason" )[0].value

                    dataObj = { "chris":chrisDay, "nick":nickDay, "steve":steveDay, "zak":zakDay, "reason":reason };

                    $.ajax({
                        type: 'PUT',
                        url: "/saveSchedule",
                        data: JSON.stringify(dataObj),
                        contentType: "application/json",
                        success: saveSuccessCallback,
                        complete: function() { 
                            },
                        error: saveErrorHandler,
                        });
                }

                function saveErrorHandler(jqXHR, textStatus, errorThrown) {
                    if (jqXHR.status == 403) {
                        // Handle permission denied error
                        showMessage("error", "<b>Woah!</b> You can <b>look</b>, but you're not allowed to <b>touch</b>.");
                    } else {
                        // Handle all other errors
                        showMessage("error", "<b>Woah! Umm...</b> We all make mistakes?");
                    }
                }

                function saveSuccessCallback(response) {
                    showMessage("info", "<b>Success!</b> New schedule saved. House Husbands notified.");
                }

                function showMessage(status, message) {
                    $( "#message-text" ).html(message);
                    messageElement.show();
                    if (status == "error") {
                        messageElement.removeClass("ui-state-highlight");
                        messageElement.addClass("ui-state-error");
                        setTimeout(function() { messageElement.fadeOut('slow'); }, 15000);
                    } else {
                        messageElement.removeClass("ui-state-error");
                        messageElement.addClass("ui-state-highlight");
                        setTimeout(function() { messageElement.fadeOut('slow'); }, 10000);
                    }
                }

            });
        </script>
        <style type="text/css">
            body { font: 62.5% "Trebuchet MS", sans-serif; margin-left: 50px; }
            #title {
              font-family: 'Carter One', "Trebuchet MS", serif;
              font-size: 43px;
              font-style: normal;
              font-weight: 400;
              text-shadow: 2px 2px 2px #aaa;
              text-decoration: none;
              text-transform: none;
              letter-spacing: 0em;
              word-spacing: 0em;
              line-height: 1.2;
              color: #304F80;
            }

            #container { width: 810px; }
            #header { width: 810px; height: 60px; }
            #header span { margin-left: 80px; }
            #header a { float: right; margin-top: 40px; margin-right: 20px; font-size: 1.2em }

            /* Droppable */
            .draggable { width: 90px; height: 30px; padding: 0.5em; text-align: center; float: left; cursor: move; margin: 10px 10px 10px 0; font-size: 1em; }

            #weekdays { float: left; width: 100%; min-height: 12em; } * html #gallery { height: 12em; } /* IE6 */
            .weekdays li { float: left; width: 100px; height: 150px; padding: 0.4em; margin: 0 0.4em 0.4em 0; text-align: center; }

            #weekday-noday { float: left; width: 150px; height: 250px; padding: 0.4em; margin: 1em 0.4em 0.4em 0; text-align: center; }

            #draggable-chris { background: LightSalmon; color: #222; }
            #draggable-nick { background: PaleVioletRed; color: #222; }
            #draggable-steve { background: DeepSkyBlue; color: #222; }
            #draggable-zak { background: #0dd; color: #222; }
            /*
            #draggable-chris { background: #BBD6FA; color: Snow; }
            #draggable-nick { background: #77975F; color: Snow; }
            #draggable-steve { background: #AB9F86; color: Snow; }
            #draggable-zak { background: #7A3838; color: Snow; }
            */

            .save { float: right; margin: 1em 0 2em 1em; padding: 0em 1em 0.5em 1em; width: 300px; height: 100%; }
            /*#button { float: right; width: 200px; height: 30px; margin: 1em 0 2em 1em; }*/
            input { width: 280px; float: right; margin: 0em 0em 0em 0em; }
            button { height: 30px; float: right; width: 180px; margin: 0.5em 0 .2em 1em; }

            #message { float: right; width: 550px; height: 50px; font-size: 1.2em; }

            #agnes-turn { float: left; margin: 1em 0 2em 1em; padding: 1em 1em 0.5em 1em; width: 200px; height: 100%; }
            #agnes-turn h1 { text-align: left; margin-top: 0px; }
            #agnes-turn-current { text-align: center; font-size: 1.2em; } 
            #agnes-turn-next { text-align: right; font-size: 0.9em; margin: 0.5em 0.5em 0.2em 0.5em }

        </style>
</head>
<body>
    <div id="header"> 
      <span id="title">Spagbol Roster</span>
      <a href="{{ url }}">{{ url_text }}</a>
    </div>

    <div id="container" class="ui-widget ui-helper-clearfix">
      <ul id="weekdays" class="weekdays ui-helper-reset ui-helper-clearfix">
        <li id="weekday-monday" class="droppable ui-widget-content">Monday</li>
        <li id="weekday-tuesday" class="droppable ui-widget-content">Tuesday</li>
        <li id="weekday-wednesday" class="droppable ui-widget-content">Wednesday</li>
        <li id="weekday-thursday" class="droppable ui-widget-content">Thursday</li>
        <li id="weekday-friday" class="droppable ui-widget-content">Friday</li>
        <li id="weekday-saturday" class="droppable ui-widget-content">Saturday</li>
        <li id="weekday-sunday" class="droppable ui-widget-content">Sunday</li>
      </ul>
      <div id="weekday-noday" class="ui-widget-content">Not Cooking</div>
      <div class="save ui-widget-content ui-corner-all">
              <h1 class="ui-widget">Comment:</h1>
              <input id="reason" placeholder="I'm feeling lazy" />
              <button class="{{ user_status }} ui-button">Save & Notify</button>
      </div>
      <div id="agnes-turn" class="ui-widget-content ui-corner-all">
        <h1 class="ui-widget"><strong>AGNES:</strong></h1>
        <div id="agnes-turn-current" class="ui-widget"><strong>{{ agnes_turn }}</strong></div>
        <div id="agnes-turn-progress"></div>
        <div id="agnes-turn-next" class="ui-widget">Next: {{ next_agnes_turn }}</div>
      </div>
      <div class="ui-widget">
        <div id="message" class="ui-state-highlight ui-corner-all" style="margin-top: 1em; padding: 0 .7em;"> 
          <p>
            <span class="ui-icon ui-icon-info" style="float: left; margin-right: .3em;"></span>
            <span id="message-text">Don't forget to click save & notify when you're happy.</span>
          </p>
        </div>
      </div>
    </div>


    <div id="draggable-chris" class="draggable ui-widget-content ui-corner-all"><p>Chris</p></div>
    <div id="draggable-nick" class="draggable ui-widget-content ui-corner-all"><p>Nick</p></div>
    <div id="draggable-steve" class="draggable ui-widget-content ui-corner-all"><p>Steve</p></div>
    <div id="draggable-zak" class="draggable ui-widget-content ui-corner-all"><p>Zak</p></div>

    </body>
</html>


